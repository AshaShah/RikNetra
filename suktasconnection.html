<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RikNetra</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link rel="stylesheet" href="css/suktaconnection.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="icon" href="Images/riknetra.png" type="image/png">
</head>

<body>
  <!-- Header Controls -->
  <div class="header-controls">
    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle" class="dark-mode-toggle">
      <i class="fas fa-moon"></i> Dark Mode
    </button>

    <!-- Kebab Menu -->
    <div class="kebab-menu" id="kebab-menu">
      <i class="fas fa-bars"></i>
    </div>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
      <div class="side-panel-header">
        <h3>RikNetra</h3>
      </div>
      <div class="side-panel-content">
        <a href="index.html"><i class="fas fa-home"></i> Home</a>
        <a href="suktasconnection.html" class="active"><i class="fas fa-project-diagram"></i> Sukta Connections</a>
        <a href="chapter.html"><i class="fas fa-book"></i> Read Suktas</a>
      </div>
    </div>

    <a href="index.html" class="home-logo" id="home-logo">
      <img src="Images/riknetra.png" alt="Home" class="logo-img">
    </a>

    <!-- Main Controls Bar -->
    <div class="controls-container">
      <div class="controls">
        <div class="select-group">
          <!-- Label for database selection -->
          <label for="database-select">Choose Connections:</label>
          <!-- Database selection and search -->
          <select id="database-select">
            <option value="database/k3database.json">2 connections</option>
            <option value="database/k4database.json">3 connections</option>
            <option value="database/k5database.json" selected>4 connections</option>
            <option value="database/k6database.json">5 connections</option>
            <option value="database/k7database.json">6 connections</option>
            <option value="database/k8database.json">7 connections</option>
            <option value="database/k9database.json">8 connections</option>
            <option value="database/k10database.json">9 connections</option>
            <option value="database/k11database.json">10 connections</option>
          </select>
        </div>

        <input type="text" id="search-input" placeholder="Search Sukta rv1.1...">

        <!-- Zoom controls -->
        <button id="zoom-in" title="Zoom In"><i class="fas fa-search-plus"></i></button>
        <button id="zoom-out" title="Zoom Out"><i class="fas fa-search-minus"></i></button>
        <button id="resetBtn" title="Reset View"><i class="fas fa-sync"></i></button>

        <!-- Display options -->
        <label>
          <input type="checkbox" id="toggle-labels" checked> Sukta Numbers
        </label>
        <label>
          <input type="checkbox" id="isolate-node-toggle"> Hide Unselected
        </label>

        <!-- Color toggle -->

        <div class="toggle-switch">
          <input type="checkbox" id="color-toggle">
          <label for="color-toggle" class="toggle-label">
            <span class="toggle-handle"></span>
            <span class="toggle-text-on">Topics Label On</span>
            <span class="toggle-text-off">Topics Label Off</span>
          </label>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container" id="main-container">
    <div class="graph-container">
      <!-- SVG for the graph only -->
      <svg id="graph-svg" width="100%" height="100%"></svg>

      <!-- HTML overlays outside SVG -->
      <div id="tooltip" class="tooltip" style="display: none;"></div>
      <div id="popup" class="popup" style="display: none;">
        <button id="close-popup" class="close-btn">Ã—</button>
        <h3 id="popup-title"></h3>
        <ul id="popup-links"></ul>
        <button id="read-chapter">Read this Chapter</button>
      </div>
      <div id="color-legend" class="color-legend" style="display: none;">
        <div class="legend-title">Topic Colors:</div>
        <div class="legend-items">
          <div class="legend-item" data-color="#ce6dbd"><span class="color-box"
              style="background-color: #ce6dbd;"></span>Creation</div>
          <div class="legend-item" data-color="#dbdb8d"><span class="color-box"
              style="background-color: #dbdb8d;"></span>Marut</div>
          <div class="legend-item" data-color="#756bb1"><span class="color-box"
              style="background-color: #756bb1;"></span>Funeral</div>
          <div class="legend-item" data-color="#5254a3"><span class="color-box"
              style="background-color: #5254a3;"></span>Surya</div>
          <div class="legend-item" data-color="#ffbb78"><span class="color-box"
              style="background-color: #ffbb78;"></span>Water</div>
          <div class="legend-item" data-color="#9c9ede"><span class="color-box"
              style="background-color: #9c9ede;"></span>Heaven & Earth</div>
          <div class="legend-item" data-color="#bcbd22"><span class="color-box"
              style="background-color: #bcbd22;"></span>Brihaspathi</div>
        </div>
      </div>
    </div>
  </div>

  <script src="darkmode/darkMode.js"></script>
  <!-- <script src="sukta_summary.js"></script> -->

  <script>
    // Add side panel toggle functionality
    document.addEventListener('DOMContentLoaded', () => {
      const kebabMenu = document.getElementById('kebab-menu');
      const sidePanel = document.getElementById('side-panel');
      const mainContainer = document.getElementById('main-container');
      const controlsContainer = document.getElementById('controls-container');
      const homeLogo = document.getElementById('home-logo');

      kebabMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        sidePanel.classList.toggle('open');
        mainContainer.classList.toggle('panel-open');
        homeLogo.style.display = sidePanel.classList.contains('open') ? 'none' : 'flex';
      });

      // Close panel when clicking outside
      document.addEventListener('click', (e) => {
        if (!sidePanel.contains(e.target) && !kebabMenu.contains(e.target)) {
          sidePanel.classList.remove('open');
          mainContainer.classList.remove('panel-open');
          homeLogo.style.display = 'flex';
        }
      });
    });

    const container = d3.select(".graph-container").node();
    const width = container.clientWidth;
    const height = container.clientHeight;
    let selectedNode = null;
    let selectedEdge = null;
    let isolateMode = false;
    let node = null;
    let link = null;
    let label = null;
    let nodes = [];
    let edges = [];

    const svg = d3.select("#graph-svg");
    const tooltip = d3.select("#tooltip");
    const popup = d3.select("#popup");
    const popupTitle = d3.select("#popup-title");
    const popupLinks = d3.select("#popup-links");

    svg.attr("width", width)
      .attr("height", height);

    const zoom = d3.zoom()
      .scaleExtent([0.1, 5])
      .on("zoom", (event) => {
        g.attr("transform", event.transform);
      });

    svg.call(zoom);

    const g = svg.append("g");

    function resetNodeColors() {
      if (node) {
        node.attr("fill", "#7fb3d5").classed("legend-highlight", false);
      }
    }

    function resetColorToggle() {
      document.getElementById("color-toggle").checked = false;
      document.getElementById("color-legend").style.display = "none";
      resetNodeColors();
    }

    function loadGraphData(database) {
      d3.json(database).then(data => {

        nodes = data.nodes;
        edges = data.edges;

        const currentWidth = container.clientWidth;
        const currentHeight = container.clientHeight;

        const weights = edges.map(d => d.weight);
        const min_weight = Math.min(...weights);
        const max_weight = Math.max(...weights);
        const new_min = 1;
        const new_max = 10;

        edges.forEach(d => {
          if (max_weight === min_weight) {
            d.normalized_weight = new_max;
          } else {
            d.normalized_weight = ((d.weight - min_weight) / (max_weight - min_weight)) * (new_max - new_min) + new_min;
          }
        });

        const xScale = d3.scaleLinear()
          .domain([d3.min(nodes, d => d.x), d3.max(nodes, d => d.x)])
          .range([100, width - 100]);

        const yScale = d3.scaleLinear()
          .domain([d3.min(nodes, d => d.y), d3.max(nodes, d => d.y)])
          .range([100, height - 100]);

        link = g.append("g")
          .selectAll("line")
          .data(edges)
          .enter()
          .append("line")
          .attr("class", "edge")
          .attr("stroke-width", d => 11 - d.normalized_weight)
          .attr("stroke", "#aaa")
          .on("click", (event, d) => {
            if (selectedEdge) {
              selectedEdge.attr("stroke", "#aaa");
            }
            selectedEdge = d3.select(event.target).attr("stroke", "red").attr("stroke-width", 11 - d.normalized_weight);
            highlightEdgeNodes(d);
          })
          .on("mouseover", (event, d) => {
            d3.select(event.target).attr("stroke", "red").attr("stroke-width", 11 - d.normalized_weight);
          })
          .on("mouseout", (event, d) => {
            if (!selectedEdge || d3.select(event.target).datum() !== selectedEdge.datum()) {
              d3.select(event.target).attr("stroke", "#aaa").attr("stroke-width", 11 - d.normalized_weight);
            }
          });

        const drag = d3.drag()
          .on("start", dragStarted)
          .on("drag", dragged)
          .on("end", dragEnded);

        node = g.append("g")
          .selectAll("circle")
          .data(nodes)
          .enter()
          .append("circle")
          .attr("class", "node")
          .attr("r", 8)
          .attr("fill", "#7fb3d5")
          .call(drag)
          .on("mouseover", (event, d) => {
            tooltip.style("display", "block")
              .html(`<strong>${d.name}</strong>`)
              .style("left", `${event.pageX + 5}px`)
              .style("top", `${event.pageY + 5}px`);
          })
          .on("mouseout", () => {
            tooltip.style("display", "none");
          })
          .on("click", (event, d) => {
            selectedNode = d;
            showPopup(d);
            zoomToNode(d);
            highlightNode(d);
          });

        label = g.append("g")
          .selectAll("text")
          .data(nodes)
          .enter()
          .append("text")
          .attr("x", d => xScale(d.x) + 10)
          .attr("y", d => yScale(d.y) + 5)
          .text(d => d.name)
          .style("font-size", "5px")
          .style("fill", "black");

        const simulation = d3.forceSimulation(nodes)
          .force("link", d3.forceLink(edges).id(d => d.id).distance(50))
          .force("charge", d3.forceManyBody().strength(-30))
          .force("center", d3.forceCenter(width / 2, height / 2))
          .force("x", d3.forceX().x(d => xScale(d.x)))
          .force("y", d3.forceY().y(d => yScale(d.y)))
          .on("tick", ticked);

        function ticked() {
          link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

          node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

          label
            .attr("x", d => d.x + 10)
            .attr("y", d => d.y + 5);
        }

        function dragStarted(event, d) {
          if (!event.active) simulation.alphaTarget(0.3).restart();
          d.fx = d.x;
          d.fy = d.y;
        }

        function dragged(event, d) {
          d.fx = event.x;
          d.fy = event.y;
          simulation.alpha(0.3).restart();
        }

        function dragEnded(event, d) {
          if (!event.active) simulation.alphaTarget(0);
          d.fx = null;
          d.fy = null;
        }

        d3.select("#toggle-labels").on("change", updateVisibility);

        d3.select("#zoom-in").on("click", () => {
          svg.transition().call(zoom.scaleBy, 1.2);
        });

        d3.select("#zoom-out").on("click", () => {
          svg.transition().call(zoom.scaleBy, 0.8);
        });

        d3.select("#search-input").on("input", function () {
          const searchTerm = this.value.trim().toLowerCase().replace(/\s/g, '');

          // Clear selections if search box is empty
          if (!searchTerm) {
            // Clear any selected node
            selectedNode = null;

            // Reset node highlighting
            node.attr("opacity", 1)
              .attr("stroke", null)
              .attr("stroke-width", null);

            // Reset edge highlighting
            link.attr("opacity", 1)
              .attr("stroke", "#aaa");

            // Reset label visibility
            label.style("opacity", 1);

            // Close popup if open
            popup.style("display", "none");

            // Reset zoom/pan if desired
            // svg.transition().call(zoom.transform, d3.zoomIdentity);

            return;
          }

          // Only search if we have actual search text
          const matchingNode = nodes.find(n =>
            n.name.toLowerCase().replace(/\s/g, '').includes(searchTerm)
          );

          if (matchingNode) {
            selectedNode = matchingNode;
            showPopup(matchingNode);
            zoomToNode(matchingNode);
            highlightNode(matchingNode);
          } else {
            // Optional: Show "no results" feedback
            tooltip.style("display", "block")
              .html(`<strong>No matching Sukta found</strong>`)
              .style("left", `${d3.event.pageX + 5}px`)
              .style("top", `${d3.event.pageY + 5}px`)
              .style("background-color", "#ffcccc");

            setTimeout(() => tooltip.style("display", "none"), 2000);
          }
        });

        d3.select("#isolate-node-toggle").on("change", function () {
          isolateMode = this.checked;
          updateVisibility();
        });

        d3.select("#close-popup").on("click", () => {
          popup.style("display", "none");
          isolateMode = false;
          updateVisibility();
        });

        function showPopup(node) {
          popupTitle.text(`${node.name} and its related Sukta`);
          popupLinks.html("");

          const connections = edges.filter(e => e.source.id === node.id)
            .sort((a, b) => a.weight - b.weight);

          connections.forEach(conn => {
            const targetNode = nodes.find(n => n.id === conn.target.id);
            if (targetNode) {
              popupLinks.append("li")
                .text(`${targetNode.name}`);
            }
          });

          popup.style("display", "block");
        }

        function zoomToNode(node) {
          const x = node.x;
          const y = node.y;
          const scale = 2;
          const transform = d3.zoomIdentity
            .translate(width / 2, height / 2)
            .scale(scale)
            .translate(-x, -y);
          svg.transition().duration(750).call(zoom.transform, transform);
        }

        function highlightNode(selectedNode) {
          node.attr("opacity", d => d.id === selectedNode.id || edges.some(e => e.source.id === selectedNode.id && e.target.id === d.id) ? 1 : 0.1)
            .attr("stroke", d => d.id === selectedNode.id ? "red" : null)
            .attr("stroke-width", d => d.id === selectedNode.id ? 2 : null);

          link.attr("opacity", d => d.source.id === selectedNode.id ? 1 : 0.1)
            .attr("stroke", d => d.source.id === selectedNode.id ? "red" : "#aaa");

          label.style("opacity", d => d.id === selectedNode.id || edges.some(e => e.source.id === selectedNode.id && e.target.id === d.id) ? 1 : 0.1);
        }

        function highlightEdgeNodes(edge) {
          node.attr("fill", d => {
            if (d.id === edge.source.id) return "blue";
            if (d.id === edge.target.id && edge.source.id !== d.id) return "green";
            return "grey";
          });
        }

        function updateVisibility() {
          const showLabels = d3.select("#toggle-labels").property("checked");

          node.attr("opacity", d => {
            if (!isolateMode) return 1;

            const isConnected = edges.some(e =>
              e.source.id === selectedNode.id && e.target.id === d.id
            );

            return d.id === selectedNode.id || isConnected ? 1 : 0;
          });

          link.attr("opacity", d => {
            if (!isolateMode) return 1;
            return d.source.id === selectedNode.id ? 1 : 0;
          });

          label.style("display", d => {
            if (!showLabels) return "none";
            if (!isolateMode) return "block";

            const isConnected = edges.some(e =>
              e.source.id === selectedNode.id && e.target.id === d.id
            );

            return d.id === selectedNode.id || isConnected ? "block" : "none";
          })
            .style("opacity", d => {
              if (!isolateMode) return 1;

              const isConnected = edges.some(e =>
                e.source.id === selectedNode.id && e.target.id === d.id
              );

              return d.id === selectedNode.id || isConnected ? 1 : 0.1;
            });
        }

        function colorNodesByGroup() {
          const customColors = [
            "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#fbc02d", "#7f7f7f", "#bcbd22", "#17becf",
            "#aec7e8", "#ffbb78", "#98df8a", "#ff9896", "#c5b0d5", "#c49c94", "#f7b6d2", "#c7c7c7", "#dbdb8d", "#9edae5",
            "#393b79", "#637939", "#8c6d31", "#843c39", "#7b4173", "#5254a3", "#8ca252", "#bd9e39", "#ad494a", "#a55194",
            "#6b6ecf", "#b5cf6b", "#e7ba52", "#d6616b", "#ce6dbd", "#9c9ede", "#cedb9c", "#e7cb94", "#e7969c", "#de9ed6",
            "#3182bd", "#31a354", "#756bb1"
          ];
          const colorScale = d3.scaleOrdinal(customColors);

          nodes.forEach(node => {
            if (node.group === undefined || node.group === null) {
              console.error(`Node ${node.id} is missing group value`);
            } else {
              console.log(`Node ${node.id} belongs to group ${node.group}`);
            }
          });

          node.attr("fill", d => {
            if (d.group !== undefined && d.group !== null) {
              return colorScale(d.group);
            } else {
              return "#43a872";
            }
          });
        }

        document.getElementById("resetBtn").addEventListener("click", () => {
          location.reload();
        });

        document.getElementById("color-toggle").addEventListener("change", function () {
          const legend = document.getElementById("color-legend");
          if (this.checked) {
            colorNodesByGroup();
            legend.style.display = "block";
          } else {
            resetNodeColors();
            legend.style.display = "none";
            // Remove legend highlights
            d3.selectAll('.node').classed('legend-highlight', false);
            document.querySelectorAll('.legend-item').forEach(li => li.classList.remove('active'));
          }
        });

        d3.select("#read-chapter").on("click", () => {
          if (selectedNode) {
            const chapterName = selectedNode.name;
            const chapterId = selectedNode.id;
            const database = d3.select("#database-select").property("value");

            window.location.href = `chapter.html?chapterId=${encodeURIComponent(chapterId)}&chapterName=${encodeURIComponent(chapterName)}&database=${encodeURIComponent(database)}`;
          } else {
            alert("Please select a node first.");
          }
        });

        // -------- LEGEND INTERACTIVITY ---------
        function setupLegendClickHighlight() {
          const legendItems = document.querySelectorAll('.legend-item');
          let lastActiveLegend = null;

          legendItems.forEach(item => {
            item.addEventListener('click', function () {
              legendItems.forEach(li => li.classList.remove('active'));
              if (lastActiveLegend === this) {
                node.classed('legend-highlight', false);
                lastActiveLegend = null;
                return;
              }
              this.classList.add('active');
              lastActiveLegend = this;
              const color = this.getAttribute('data-color').toLowerCase();
              node.classed('legend-highlight', false);
              node.each(function (d, i) {
                const fill = d3.select(this).attr('fill')?.toLowerCase();
                if (fill === color) {
                  d3.select(this).classed('legend-highlight', true);
                }
              });

              // -------- Center-focus highlighted nodes --------
              const highlightedNodes = [];
              node.each(function (d) {
                if (d3.select(this).classed('legend-highlight')) {
                  highlightedNodes.push(d);
                }
              });
              if (highlightedNodes.length > 0) {
                const avgX = d3.mean(highlightedNodes, d => d.x);
                const avgY = d3.mean(highlightedNodes, d => d.y);
                const scale = 2;
                const svgWidth = width;
                const svgHeight = height;
                const transform = d3.zoomIdentity
                  .translate(svgWidth / 2, svgHeight / 2)
                  .scale(scale)
                  .translate(-avgX, -avgY);
                svg.transition().duration(750).call(zoom.transform, transform);
              }
            });
          });
        }

        // Whenever the legend appears, set up interactivity
        const observer = new MutationObserver(function (mutationsList) {
          for (const mutation of mutationsList) {
            if (
              mutation.type === "attributes" &&
              mutation.attributeName === "style" &&
              document.getElementById("color-legend").style.display !== "none"
            ) {
              setupLegendClickHighlight();
            }
          }
        });
        observer.observe(document.getElementById("color-legend"), { attributes: true });

      }).catch(error => {
        console.error("Error loading the graph data:", error);
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const database = urlParams.get('database');
    if (database) {
      d3.select("#database-select").property("value", database);
      loadGraphData(database);
    } else {
      loadGraphData(d3.select("#database-select").property("value"));
    }

    d3.select("#database-select").on("change", function () {
      // Clear search input
      document.getElementById("search-input").value = "";

      // Close any open popup
      popup.style("display", "none");

      // Reset isolation mode
      isolateMode = false;
      d3.select("#isolate-node-toggle").property("checked", false);

      // Reset any selected nodes/edges
      selectedNode = null;
      selectedEdge = null;

      // Clear and reload the graph
      g.selectAll("*").remove();
      resetColorToggle();
      loadGraphData(this.value);
    });

  </script>

</body>

</html>